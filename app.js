// Updated app.js including Make Me a Hanzi integration
let MMH_DICT=null;let MMH_READY=false;async function loadMMHDictionary(){if(MMH_READY)return;const e="https://raw.githubusercontent.com/skishore/makemeahanzi/master/data/dictionary.txt",t=await fetch(e);if(!t.ok)throw new Error("dictionary.txt konnte nicht geladen werden");const n=await t.text();MMH_DICT={},n.split("\n").forEach((e=>{if(!e||!e.includes("#"))return;const[t,n,i]=e.split("#").map((e=>e.trim()));MMH_DICT[t]={pinyin:n,definition:i}})),MMH_READY=!0}class ChineseCharacterAPI{constructor(){this.cache=new Map,this.fallbackData=this.getMinimalFallbackData()}async getCharacterData(e){if(this.cache.has(e))return this.cache.get(e);if(!MMH_READY)try{await loadMMHDictionary()}catch(e){console.warn("MMH load",e)}if(MMH_READY&&MMH_DICT[e]){const t=MMH_DICT[e];return this.cache.set(e,this.buildDataFromMMH(e,t)),this.cache.get(e)}try{const t=await this.fetchFromPrimaryAPI(e);if(t)return this.cache.set(e,t),t}catch(e){console.warn("Primary API",e)}try{const t=await this.fetchFromFallbackAPI(e);if(t)return this.cache.set(e,t),t}catch(e){console.warn("Fallback",e)}return this.fallbackData[e]||null}buildDataFromMMH(e,t){return{character:e,pinyin:t.pinyin,tone:this.extractTone(t.pinyin),meaning_de:this.translateToGerman(t.definition)||t.definition,meaning_en:t.definition,strokes:0,hsk_level:this.estimateHSKLevel(e),words:this.generateExampleWords(e,t)}}async fetchFromPrimaryAPI(e){const t="https://ccdb.hemiola.com";try{const n=await fetch(`${t}/characters/${encodeURIComponent(e)}`);if(!n.ok)throw new Error("not found");const i=await n.json();return this.normalizeAPIData(e,i)}catch(e){throw e}}async fetchFromFallbackAPI(e){return null}normalizeAPIData(e,t){return{character:e,pinyin:t.pinyin||"",tone:this.extractTone(t.pinyin),meaning_de:this.translateToGerman(t.definition)||t.definition,meaning_en:t.definition,strokes:t.stroke_count||0,hsk_level:this.estimateHSKLevel(e),words:this.generateExampleWords(e,t)}}extractTone(e){if(!e)return 0;const t={ā:1,á:2,ǎ:3,à:4,ē:1,é:2,ě:3,è:4,ī:1,í:2,ǐ:3,ì:4,ō:1,ó:2,ǒ:3,ò:4,ū:1,ú:2,ǔ:3,ù:4,ü:1,ǘ:2,ǚ:3,ǜ:4};for(const n of e)if(t[n])return t[n];return 0}translateToGerman(e){if(!e)return null;const t={water:"Wasser",fire:"Feuer",mountain:"Berg",tree:"Baum",person:"Person",big:"groß",small:"klein",sun:"Sonne",moon:"Mond",earth:"Erde",gold:"Gold",wood:"Holz",metal:"Metall",hand:"Hand",car:"Auto",good:"gut",learn:"lernen",study:"studieren"};for(const[n,i]of Object.entries(t))if(e.toLowerCase().includes(n))return i;return null}estimateHSKLevel(e){return["一","二","三","人","大","小","水","火","山","木","日","月","好","学","中","国"].includes(e)?1:2}generateExampleWords(e,t){const n={学:[{word:"学生",pinyin:"xuéshēng",meaning_de:"Student"},{word:"学校",pinyin:"xuéxiào",meaning_de:"Schule"},{word:"学习",pinyin:"xuéxí",meaning_de:"lernen"}],好:[{word:"你好",pinyin:"nǐhǎo",meaning_de:"Hallo"},{word:"很好",pinyin:"hěnhǎo",meaning_de:"sehr gut"},{word:"好的",pinyin:"hǎode",meaning_de:"okay"}]};return n[e]||[{word:e+"子",pinyin:"",meaning_de:"Beispielwort 1"},{word:"大"+e,pinyin:"",meaning_de:"Beispielwort 2"},{word:e+"们",pinyin:"",meaning_de:"Beispielwort 3"}]}getMinimalFallbackData(){return{学:{character:"学",pinyin:"xué",tone:2,meaning_de:"lernen, studieren",meaning_en:"to learn, to study",strokes:8,hsk_level:1,words:[{word:"学生",pinyin:"xuéshēng",meaning_de:"Student"},{word:"学校",pinyin:"xuéxiào",meaning_de:"Schule"}]},好:{character:"好",pinyin:"hǎo",tone:3,meaning_de:"gut, schön",meaning_en:"good",strokes:6,hsk_level:1,words:[{word:"你好",pinyin:"nǐhǎo",meaning_de:"Hallo"},{word:"很好",pinyin:"hěnhǎo",meaning_de:"sehr gut"}]}}}}
const api=new ChineseCharacterAPI;document.getElementById("generateBtn").addEventListener("click",generateWorksheet),document.getElementById("printBtn").addEventListener("click",(()=>window.print())),document.getElementById("charInput").addEventListener("keypress",(e=>{"Enter"===e.key&&generateWorksheet()}));async function generateWorksheet(){const e=document.getElementById("charInput").value.trim();if(!e)return void showError("Bitte geben Sie ein Zeichen ein.");showLoading("Zeichen wird geladen...");try{const t=await api.getCharacterData(e);return t?(hideError(),displayWorksheet(t)):showError(`Keine Daten für Zeichen "${e}" gefunden.`)}catch(e){console.error(e),showError("Fehler beim Laden der Daten.")}}function displayWorksheet(e){document.getElementById("charDisplay").textContent=e.character,document.getElementById("pinyinDisplay").textContent=e.pinyin,document.getElementById("meaningDe").textContent=e.meaning_de,document.getElementById("meaningEn").textContent=e.meaning_en,document.getElementById("strokeCount").textContent=`${e.strokes||"?"} Striche`,document.getElementById("hskLevel").textContent="HSK "+e.hsk_level,generatePracticeGrid(e.character),generateWordsList(e.words),document.getElementById("worksheet").classList.remove("hidden"),document.getElementById("printBtn").classList.remove("hidden")}function generatePracticeGrid(e){const t=document.getElementById("practiceGrid");t.innerHTML="";for(let n=0;n<20;n++){const i=document.createElement("div");i.className="practice-cell",0===n?(i.textContent=e,i.classList.add("reference")):n<=3&&(i.textContent=e,i.classList.add(`fade-${n}`)),t.appendChild(i)}}function generateWordsList(e){const t=document.getElementById("wordsGrid");t.innerHTML="",e.forEach((e=>{const n=document.createElement("div");n.className="word-card",n.innerHTML=`<div class=\"word-chinese\">${e.word}</div><div class=\"word-pinyin\">${e.pinyin}</div><div class=\"word-meaning\">${e.meaning_de}</div>`,t.appendChild(n)}))}function showLoading(e){const t=document.getElementById("errorMsg");t.textContent=e,t.className="error loading",t.classList.remove("hidden")}function showError(e){const t=document.getElementById("errorMsg");t.textContent=e,t.className="error",t.classList.remove("hidden")}function hideError(){document.getElementById("errorMsg").classList.add("hidden")}document.getElementById("charInput").focus(),loadMMHDictionary();